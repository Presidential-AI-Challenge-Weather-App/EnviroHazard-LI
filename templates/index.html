<!DOCTYPE html>
<html>
<head>
    <title>EnviroHazardLI — Long Island Environmental Monitor</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            background: #0a1f0a;
            color: #e8f5e9;
            min-height: 100vh;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        header {
            text-align: center;
            padding: 25px 20px;
            background: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%);
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        header h1 {
            font-size: 2.2em;
            font-weight: 700;
            color: #a5d6a7;
            margin-bottom: 5px;
        }
        header p { color: #c8e6c9; font-size: 0.95em; }

        .form-container {
            background: #1b3a1b;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            text-align: center;
            border: 1px solid #2e7d32;
        }
        select, button {
            padding: 10px 18px;
            font-size: 0.95em;
            border-radius: 8px;
            border: 1px solid #4caf50;
            margin: 0 8px;
            background: #1b3a1b;
            color: #c8e6c9;
        }
        button {
            background: linear-gradient(135deg, #2e7d32 0%, #388e3c 100%);
            color: #ffffff;
            cursor: pointer;
            font-weight: 600;
            border: none;
            transition: all 0.25s ease;
        }
        button:hover { transform: translateY(-1px); }

        .main-content { display: flex; gap: 20px; margin-bottom: 25px; }
        .map-container { flex: 0 0 60%; }
        #map {
            height: 500px;
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 2px solid #2e7d32;
        }

        .weather-sidebar {
            flex: 0 0 38%;
            background: #1b3a1b;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #2e7d32;
            overflow-y: auto;
            max-height: 500px;
        }
        .weather-sidebar h3 {
            color: #a5d6a7;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #2e7d32;
            padding-bottom: 8px;
        }
        .weather-info {
            background: #0f2a0f;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid #4caf50;
        }
        .weather-info strong { color: #81c784; }
        canvas { width: 100% !important; height: 180px !important; margin-top: 10px; }

        .risk-card {
            background: #1b3a1b;
            border-radius: 12px;
            padding: 18px;
            margin: 15px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border-left: 4px solid #4caf50;
        }
        .risk-card.low { border-left-color: #66bb6a; }
        .risk-card.moderate { border-left-color: #ffa726; }
        .risk-card.high { border-left-color: #ef5350; }
        .risk-card.extreme { border-left-color: #d32f2f; }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2e7d32;
        }
        .card-header h3 { color: #a5d6a7; font-size: 1.2em; margin: 0; }

        .severity-badge {
            padding: 5px 12px;
            border-radius: 16px;
            font-weight: 700;
            font-size: 0.85em;
        }
        .severity-badge.LOW { background: #1b5e20; color: #a5d6a7; }
        .severity-badge.MODERATE { background: #e65100; color: #ffcc80; }
        .severity-badge.HIGH { background: #b71c1c; color: #ffcdd2; }
        .severity-badge.EXTREME { background: #880e4f; color: #f8bbd0; }

        .warning-box {
            background: rgba(255, 167, 38, 0.1);
            padding: 10px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 3px solid #ffa726;
            font-weight: 600;
            color: #ffcc80;
        }

        .summary-section {
            margin-top: 12px;
            padding: 12px;
            background: #0f2a0f;
            border-radius: 8px;
        }
        .summary-section h4 {
            color: #81c784;
            font-size: 1em;
            margin-bottom: 8px;
        }

        .context-text {
            background: rgba(76, 175, 80, 0.1);
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #4caf50;
            margin: 8px 0;
            line-height: 1.6;
            color: #c8e6c9;
            font-size: 0.9em;
        }

        .action-list {
            list-style: none;
            padding: 0;
            margin: 8px 0;
        }
        .action-list li {
            padding: 8px 10px;
            margin: 6px 0;
            background: rgba(76, 175, 80, 0.05);
            border-radius: 6px;
            border-left: 2px solid #4caf50;
            line-height: 1.4;
            color: #c8e6c9;
            font-size: 0.88em;
        }
        .action-list.government li { border-left-color: #7cb342; }

        .activities-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .activity-item {
            background: rgba(76, 175, 80, 0.1);
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #4caf50;
            font-size: 0.9em;
            color: #a5d6a7;
            text-align: center;
        }
        .activity-item.caution {
            background: rgba(255, 167, 38, 0.1);
            border-color: #ffa726;
            color: #ffcc80;
        }
        .activity-item.not-recommended {
            background: rgba(239, 83, 80, 0.1);
            border-color: #ef5350;
            color: #ffcdd2;
        }

        .error {
            background: rgba(211, 47, 47, 0.2);
            color: #ffcdd2;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 3px solid #d32f2f;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f2a0f; }
        ::-webkit-scrollbar-thumb { background: #2e7d32; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #388e3c; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>EnviroHazardLI</h1>
            <p>Your local environmental hazards and activity recommendations for Long Island</p>
        </header>

        <div class="form-container">
            <form method="POST" aria-label="Select location and analyze hazards">
                <label for="city" style="font-weight: 600; color: #a5d6a7;">Pick a town:</label>
                <select name="city" id="city" aria-label="Town selection">
                    <option value="">Choose a town...</option>
                    {% for c in cities %}
                        <option value="{{c}}" {% if c == city %}selected{% endif %}>{{c}}</option>
                    {% endfor %}
                </select>
                <button type="submit" title="Run the hazard analysis for the selected town">Analyze Hazards</button>
            </form>
            <p style="margin-top:8px; color:#c8e6c9; font-size:0.9em;">Tip: analysis uses NOAA and USGS data where available; otherwise a safe heuristic is used.</p>
        </div>

        {% if error_message %}
            <div class="error" role="alert"><strong>Problem:</strong> {{ error_message }}</div>
        {% endif %}

        {% if city and lat %}
        <div class="main-content" aria-live="polite">
            <div class="map-container" role="region" aria-label="Map">
                <div id="map"></div>
            </div>

            <aside class="weather-sidebar" role="complementary" aria-label="Weather and activity sidebar">
                <h3>{{ city }}</h3>

                <div class="weather-info">
                    <div><strong>Coordinates:</strong> {{ lat|round(4) }}, {{ lon|round(4) }}</div>
                    {% if insights and insights|length > 0 %}
                        <div style="margin-top:8px; color:#c8e6c9; font-size:0.9em;">{{ insights|join(', ') }}</div>
                    {% endif %}
                </div>

                {% if forecast %}
                    <div class="weather-info" aria-label="Current conditions">
                        <strong>Now</strong><br>
                        {{ forecast['name'] }} — {{ forecast['shortForecast'] }}<br>
                        <strong>Temperature:</strong> {{ forecast['temperature'] }}°{{ forecast['temperatureUnit'] }}<br>
                        {% if forecast.get('windSpeed') %}
                            <strong>Wind:</strong> {{ forecast['windSpeed'] }} {{ forecast.get('windDirection','') }}
                        {% endif %}
                    </div>
                {% endif %}

                {% if ai_preds and ai_preds|length > 0 %}
                <div class="weather-info" aria-label="24 hour temperature chart">
                    <strong>Next 24 hours — temperature</strong>
                    <canvas id="aiChart" aria-hidden="false"></canvas>
                </div>
                {% endif %}

                {% if wind_preds and wind_preds|length > 0 %}
                <div class="weather-info" aria-label="24 hour wind chart">
                    <strong>Next 24 hours — wind</strong>
                    <canvas id="windChart" aria-hidden="false"></canvas>
                </div>
                {% endif %}

                {% if activities %}
                <div class="weather-info" style="border-left: 3px solid #81c784;" aria-label="Activity recommendations">
                    <strong>Activity suggestions</strong>

                    {% if activities['safe']|length > 0 %}
                    <div style="margin-top: 10px;">
                        <div style="color: #81c784; font-weight: 600; margin-bottom: 5px;">✓ Good to go</div>
                        {% for activity in activities['safe'] %}
                            <div style="background: rgba(76, 175, 80, 0.1); padding: 6px 10px; margin: 4px 0; border-radius: 6px; font-size: 0.88em; border-left: 2px solid #66bb6a;">{{ activity }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if activities['caution']|length > 0 %}
                    <div style="margin-top: 10px;">
                        <div style="color: #ffcc80; font-weight: 600; margin-bottom: 5px;">⚠ Use caution</div>
                        {% for activity in activities['caution'] %}
                            <div style="background: rgba(255, 167, 38, 0.1); padding: 6px 10px; margin: 4px 0; border-radius: 6px; font-size: 0.88em; border-left: 2px solid #ffa726;">{{ activity }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    {% if activities['not_recommended']|length > 0 %}
                    <div style="margin-top: 10px;">
                        <div style="color: #ffcdd2; font-weight: 600; margin-bottom: 5px;">✗ Not recommended</div>
                        {% for activity in activities['not_recommended'] %}
                            <div style="background: rgba(239, 83, 80, 0.1); padding: 6px 10px; margin: 4px 0; border-radius: 6px; font-size: 0.88em; border-left: 2px solid #ef5350;">{{ activity }}</div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </aside>
        </div>
        {% endif %}

        <div class="hazard-grid" role="main">
            {% if city and fire_summary %}
            <div class="risk-card {{ fire_risk.lower() }}">
                <div class="card-header">
                    <h3>Fire hazard</h3>
                    <span class="severity-badge {{ fire_summary['severity'] }}">{{ fire_summary['severity'] }}</span>
                </div>

                {% if fire_warnings %}
                    {% for w in fire_warnings %}
                        <div class="warning-box" aria-live="polite">{{ w }}</div>
                    {% endfor %}
                {% endif %}

                <div class="summary-section">
                    <h4>Current snapshot</h4>
                    <div class="context-text">{{ fire_summary['context'] }}</div>
                </div>

                <div class="summary-section">
                    <h4>What residents can do</h4>
                    <ul class="action-list">
                        {% for action in fire_summary['user_actions'][:5] %}
                            <li>{{ action }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="summary-section">
                    <h4>Recommended government steps</h4>
                    <ul class="action-list government">
                        {% for action in fire_summary['government_actions'][:5] %}
                            <li>{{ action }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="risk-card {{ flood_risk.lower() }}">
                <div class="card-header">
                    <h3>Flood hazard</h3>
                    <span class="severity-badge {{ flood_summary['severity'] }}">{{ flood_summary['severity'] }}</span>
                </div>

                {% if flood_warnings %}
                    {% for w in flood_warnings %}
                        <div class="warning-box" aria-live="polite">{{ w }}</div>
                    {% endfor %}
                {% endif %}

                <div class="summary-section">
                    <h4>Current snapshot</h4>
                    <div class="context-text">{{ flood_summary['context'] }}</div>
                </div>

                <div class="summary-section">
                    <h4>What residents can do</h4>
                    <ul class="action-list">
                        {% for action in flood_summary['user_actions'][:5] %}
                            <li>{{ action }}</li>
                        {% endfor %}
                    </ul>
                </div>

                <div class="summary-section">
                    <h4>Recommended government steps</h4>
                    <ul class="action-list government">
                        {% for action in flood_summary['government_actions'][:5] %}
                            <li>{{ action }}</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>

            {% if activities %}
            <div class="risk-card low">
                <div class="card-header">
                    <h3>Outdoor activity guide</h3>
                </div>

                {% if activities['safe'] and activities['safe']|length > 0 %}
                <div class="summary-section">
                    <h4>Good to go</h4>
                    <div class="activities-list">
                        {% for activity in activities['safe'] %}
                            <div class="activity-item">{{ activity }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if activities['caution'] and activities['caution']|length > 0 %}
                <div class="summary-section">
                    <h4>Use caution</h4>
                    <div class="activities-list">
                        {% for activity in activities['caution'] %}
                            <div class="activity-item caution">{{ activity }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if activities['not_recommended'] and activities['not_recommended']|length > 0 %}
                <div class="summary-section">
                    <h4>Not recommended</h4>
                    <div class="activities-list">
                        {% for activity in activities['not_recommended'] %}
                            <div class="activity-item not-recommended">{{ activity }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}
            {% endif %}
        </div>

        {% if city and lat %}
            <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
            <script>
                // Initialize the map centered on the selected town
                var map = L.map('map').setView([{{lat}}, {{lon}}], 11);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap contributors, © CARTO'
                }).addTo(map);

                var marker = L.marker([{{lat}}, {{lon}}]).addTo(map);

                // 24-hour temperature chart
                {% if ai_preds and ai_preds|length > 0 %}
                var ctx = document.getElementById('aiChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ["1h","2h","3h","4h","5h","6h","7h","8h","9h","10h","11h","12h","13h","14h","15h","16h","17h","18h","19h","20h","21h","22h","23h","24h"],
                        datasets: [{
                            label: 'Temperature (°F)',
                            data: {{ ai_preds|tojson }},
                            borderColor: '#66bb6a',
                            backgroundColor: 'rgba(102, 187, 106, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#c8e6c9' } } },
                        scales: {
                            y: { ticks: { color: '#c8e6c9' }, grid: { color: '#2e7d32' } },
                            x: { ticks: { color: '#c8e6c9' }, grid: { color: '#2e7d32' } }
                        }
                    }
                });
                {% endif %}

                // 24-hour wind chart
                {% if wind_preds and wind_preds|length > 0 %}
                var wctx = document.getElementById('windChart').getContext('2d');
                new Chart(wctx, {
                    type: 'bar',
                    data: {
                        labels: ["1h","2h","3h","4h","5h","6h","7h","8h","9h","10h","11h","12h","13h","14h","15h","16h","17h","18h","19h","20h","21h","22h","23h","24h"],
                        datasets: [{
                            label: 'Wind (mph)',
                            data: {{ wind_preds|tojson }},
                            backgroundColor: 'rgba(102, 187, 106, 0.6)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#c8e6c9' } } },
                        scales: {
                            y: { ticks: { color: '#c8e6c9' }, grid: { color: '#2e7d32' } },
                            x: { ticks: { color: '#c8e6c9' }, grid: { color: '#2e7d32' } }
                        }
                    }
                });
                {% endif %}
            </script>
        {% endif %}
    </div>
</body>
</html>
